name: Build PDF Visual Editor 32bits

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-linux-32:
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Clonar el repositorio desde GitLab que contiene el script de construcci√≥n
      - name: Checkout repository
        uses: actions/checkout@v4

      # Paso 2: Instalar Docker-in-Docker (DinD)
      - name: Set up Docker-in-Docker (DinD)
        uses: docker/setup-buildx-action@v2
        with:
          use-docker-layer-caching: true

      # Paso 3: Clonar el repositorio de GitLab que contiene el script 'build-image.sh'
      - name: Clone docker-32bit/ubuntu repository
        run: |
          git clone https://gitlab.com/docker-32bit/ubuntu.git
          #cd ubuntu

      # Paso 4: Construir la imagen Ubuntu 32-bit dentro de Docker-in-Docker
      - name: Build Ubuntu 32-bit Docker image
        run: |
          # Hacer el script ejecutable
          chmod +x build-image.sh
          
          # Ejecutar el script para construir la imagen 32bit/ubuntu
          ./build-image.sh

      # Paso 5: Usar la imagen Ubuntu 32-bit para instalar dependencias y construir el proyecto
      - name: Install dependencies and build project
        run: |
          docker run --rm -v $(pwd):/workspace -w /workspace 32bit/ubuntu:16.04 bash -c "
            sudo apt update &&
            sudo apt install -y libc6:i386 libstdc++6:i386 python3.10:i386 python3-pip:i386 &&
            python3.10 -m pip install --upgrade pip &&
            python3.10 -m pip install -r pdf_visual_editor/requirements.txt &&
            python3.10 -m pip install pyinstaller PySide2 &&
            chmod +x pdf_visual_editor/build_exe.sh &&
            pyinstaller --distpath pdf_visual_editor/dist-i386 pdf_visual_editor/build_exe.spec
          "

      # Paso 6: Subir el artefacto de 32-bit
      - name: Upload Linux 32-bit artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-32bit
          path: pdf_visual_editor/dist-i386/
