name: Build PDF Visual Editor 32bits

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-linux-32:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Docker-in-Docker (DinD)
      - name: Set up Docker-in-Docker (DinD)
        uses: docker/setup-buildx-action@v2
        with:
          use-docker-layer-caching: true

      # Step 3: Clone the repository containing the 'build-image.sh' script
      - name: Clone docker-32bit/ubuntu repository
        run: |
          git clone https://gitlab.com/docker-32bit/ubuntu.git
          cd ubuntu
          # Optionally verify if the 'build-image.sh' file exists
          ls -l build-image.sh

      # Step 4: Build Ubuntu 32-bit Docker image
      - name: Build Ubuntu 32-bit Docker image
        run: |
          cd ubuntu
          chmod +x build-image.sh || exit 1
          ./build-image.sh || exit 1

      # Step 5: Use the Ubuntu 32-bit image to install dependencies and build the project
      - name: Install dependencies and build project
        run: |
          docker run --rm -v $(pwd):/workspace -w /workspace 32bit/ubuntu:16.04 bash -c "
            sudo apt update &&
            sudo apt install -y libc6:i386 libstdc++6:i386 python3.10:i386 python3-pip:i386 &&
            python3.10 -m pip install --upgrade pip &&
            python3.10 -m pip install -r pdf_visual_editor/requirements.txt &&
            python3.10 -m pip install pyinstaller PySide2 &&
            chmod +x pdf_visual_editor/build_exe.sh &&
            pyinstaller --distpath pdf_visual_editor/dist-i386 pdf_visual_editor/build_exe.spec
          "

      # Step 6: Upload Linux 32-bit artifact
      - name: Upload Linux 32-bit artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-32bit
          path: pdf_visual_editor/dist-i386/
